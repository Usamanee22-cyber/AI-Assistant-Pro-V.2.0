<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Lange-Model V.95.3 (900-Words Absolute)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Noto+Sans+Thai:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans Thai', sans-serif; box-sizing: border-box; }
        body { background: #010409; color: #e6edf3; height: 100vh; overflow: hidden; margin: 0; }
        .glass { background: rgba(13, 17, 23, 0.9); backdrop-filter: blur(10px); border: 1px solid #30363d; }
        .v95-accent { color: #58a6ff; }
        #viewport { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg-line { display: flex; width: 100%; }
        .bubble { padding: 10px 16px; border-radius: 18px; max-width: 85%; min-width: 40px; width: auto; line-height: 1.5; font-size: 14px; word-wrap: break-word; display: inline-block; }
        .assistant .bubble { background: #161b22; border: 1px solid #30363d; border-left: 4px solid #58a6ff; }
        .user { justify-content: flex-end; }
        .user .bubble { background: #1f6feb; color: white; border-bottom-right-radius: 4px; }
        .trace-line { font-family: 'Fira Code', monospace; font-size: 10px; padding: 2px 8px; border-left: 2px solid #58a6ff; margin-bottom: 2px; color: #8b949e; }
        .hidden { display: none !important; }
        .v-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px; }
        .v-item { font-size: 8px; background: #0d1117; border: 1px solid #30363d; color: #58a6ff; text-align: center; padding: 2px; border-radius: 3px; }
        .admin-btn { background: #21262d; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; border: 1px solid #30363d; cursor: pointer; }
        .admin-btn.active { background: #1f6feb; border-color: #58a6ff; color: white; }
    </style>
</head>
<body>

<div id="gatekeeper" class="h-full flex flex-col items-center justify-center">
    <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl mx-auto mb-4 flex items-center justify-center text-4xl font-black text-white shadow-xl">L</div>
        <h1 class="text-3xl font-black italic">LANGE <span class="v95-accent">V95.3</span></h1>
    </div>
    <div class="w-72 space-y-4">
        <input type="text" id="accessName" class="w-full bg-[#0d1117] border border-[#30363d] p-4 rounded-xl text-center text-white outline-none focus:border-blue-500 font-bold" placeholder="NAME">
        <button onclick="checkAccess()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black shadow-lg">INITIALIZE</button>
    </div>
</div>

<div id="mainSystem" class="hidden h-full flex flex-col">
    <header id="adminBar" class="p-3 bg-black border-b border-[#30363d] flex justify-between items-center">
        <div class="flex gap-2">
            <button id="btnChat" onclick="switchMode('chat')" class="admin-btn active">CHAT</button>
            <button id="btnLearning" onclick="switchMode('learning')" class="admin-btn">LEARNING</button>
            <button id="btnGraph" onclick="switchMode('graph')" class="admin-btn">GRAPH (LIVE)</button>
        </div>
        <div class="text-[10px] font-bold text-gray-500 tracking-widest">900+ RAW PARAMETERS</div>
    </header>

    <div class="flex-1 overflow-hidden flex">
        <div id="chatView" class="flex-1 flex flex-col overflow-hidden">
            <div id="viewport"></div>
            <div id="processTrace" class="h-40 glass border-t border-[#30363d] p-4 overflow-y-auto">
                <div id="traceLog"></div>
            </div>
            <form id="chatForm" class="p-4 bg-black border-t border-[#30363d] flex gap-3">
                <input type="text" id="userInput" class="flex-1 bg-[#0d1117] p-4 rounded-xl text-white outline-none border border-transparent focus:border-blue-500 text-sm" placeholder="Message...">
                <button type="submit" class="bg-blue-600 px-8 rounded-xl font-black text-white text-sm">EXECUTE</button>
            </form>
        </div>

        <div id="learningView" class="hidden flex-1 p-8 bg-[#010409] overflow-y-auto">
            <h2 class="text-xl font-black mb-4 v95-accent italic">LEARNING CORE (900-RAW)</h2>
            <div class="mb-6 p-4 border border-[#30363d] rounded-xl bg-black">
                <p class="text-[11px] text-gray-400 mb-3 uppercase font-black">Train New Token: หมวด-คำใหม่</p>
                <div class="flex gap-2">
                    <input type="text" id="learnInput" class="flex-1 bg-[#0d1117] border border-[#30363d] p-3 rounded-lg text-sm text-white" placeholder="เช่น: คณิตศาสตร์-แคลคูลัส">
                    <button onclick="trainToken()" class="bg-green-600 px-6 rounded-lg font-bold text-sm text-white">TRAIN & SAVE</button>
                </div>
            </div>
            <div id="vocabList" class="space-y-4"></div>
        </div>

        <div id="graphView" class="hidden flex-1 p-8 bg-[#010409] overflow-y-auto">
            <h2 class="text-xl font-black mb-4 v95-accent italic">NEURAL KNOWLEDGE FLOW</h2>
            <div class="glass p-6 rounded-2xl h-[450px] w-full">
                <canvas id="liveLossChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
// --- [MONOLITH & LOCAL STORAGE SYSTEM] ---
const DEFAULT_MONOLITH = {
    "คณิต": ["บวก","ลบ","คูณ","หาร","เท่ากับ","สมการ","โจทย์","ตัวเลข","เลข","เปอร์เซ็นต์","ร้อยละ","สแควรูท","ยกกำลัง","เศษส่วน","ทศนิยม","วงเล็บ","ค่าคงที่","ตัวแปร","พีชคณิต","ตรีโกณ","แคลคูลัส","สถิติ","กราฟ","พิกัด","มุม","องศา","เรเดียน","วงกลม","สามเหลี่ยม","สี่เหลี่ยม","พื้นที่","ปริมาตร","รัศมี","เส้นผ่านศูนย์กลาง","ด้าน","ฐาน","สูง","ยาว","กว้าง","ลึก","น้ำหนัก","ระยะทาง","เวลา","ความเร็ว","ความเร่ง","แรง","พลังงาน","อุณหภูมิ","กระแส","แรงดัน","ความต้านทาน","ฐานสอง","ฐานสิบ","ตรรกศาสตร์","เซต","ความน่าจะเป็น","ฟังก์ชัน","ลิมิต","อนุพันธ์","อินทิกรัล","เมทริกซ์","เวกเตอร์","เรขาคณิต","ความชัน","จุดตัด","ขนาน","ตั้งฉาก","ทรงกรวย","ทรงกระบอก","ทรงกลม","พหุนาม","อนุกรม","ลำดับ","สูตร","นิยาม","ทฤษฎี","บทพิสูจน์","ตาราง","ค่าเฉลี่ย","ฐานนิยม","มัธยฐาน","ส่วนเบี่ยงเบน","ความแปรปรวน","ความถี่","ความสัมพันธ์","ผลรวม","ตัวประกอบ","จำนวนเต็ม","จำนวนจริง","จำนวนเชิงซ้อน","จำนวนตรรกยะ","จำนวนอตรรกยะ","หาสัมประสิทธิ์","นิพจน์","ตัวหารร่วม","ตัวคูณร่วม"],
    "ธรรมชาติ": ["ป่า","เขา","ดิน","หิน","ทราย","น้ำ","ลม","ไฟ","เมฆ","หมอก","แดด","ฝน","พายุ","รุ้ง","ทะเล","คลื่น","หาด","เกาะ","ถ้ำ","แม่น้ำ","ลำธาร","น้ำตก","หุบเขา","หน้าผา","ต้นไม้","หญ้า","ดอกไม้","ใบไม้","กิ่งไม้","ราก","เมล็ด","ผลไม้","แร่ธาตุ","ทองคำ","เงิน","เหล็ก","ทองแดง","สังกะสี","น้ำมัน","ก๊าซ","ถ่านหิน","เพชร","พลอย","ดินเหนียว","ดินทราย","ดินร่วน","อากาศ","ออกซิเจน","ไนโตรเจน","คาร์บอน","ชั้นบรรยากาศ","โอโซน","ลมบก","ลมทะเล","มรสุม","ไต้ฝุ่น","แผ่นดินไหว","ภูเขาไฟ","ลาวา","แมกมา","ธารน้ำแข็ง","ขั้วโลก","เส้นศูนย์สูตร","ฤดูกาล","ฤดูร้อน","ฤดูหนาว","ฤดูฝน","ใบไม้ผลิ","ใบไม้ร่วง","ป่าดิบชิง","ป่าสน","ทุ่งหญ้า","ทะเลทราย","ปะการัง","สาหร่าย","พืช","สัตว์","แมลง","แบคทีเรีย","รา","ไวรัส","ระบบนิเวศ","โซ่อาหาร","ความหลากหลาย","การปรับตัว","การวิวัฒนาการ","การสืบพันธุ์","การเจริญเติบโต","แสงสว่าง","ความมืด","กลางวัน","กลางคืน","สุริยุปราคา","จันุปราคา"],
    "ความรู้สึก": ["รัก","เกลียด","โกรธ","หลง","เศร้า","ดีใจ","เสียใจ","กลัว","กล้า","ระแวง","สงสัย","มั่นใจ","ตื่นเต้น","เบื่อ","เหงา","ท้อ","หิว","อิ่ม","ง่วง","เหนื่อย","สดชื่น","ผ่อนคลาย","เครียด","กกังวล","ภูมิใจ","ละอาย","สำนึก","ขอบคุณ","ขอโทษ","เมตตา","กรุณา","มุทิตา","อุเบกขา","สงบ","ฟุ้งซ่าน","ห่วง","ใย","คิดถึง","คะนึง","โหยหา","เจ็บ","ปวด","ร้าว","ทรมาน","สุข","สำราญ","รื่นรมย์","หงุดหงิด","รำคาญ","อาฆาต","แค้น","อภัย","ชื่นชม","ศรัทธา","เลื่อมใส","หวัง","สิ้นหวัง","รันทด","อนาถ","เวทนา","เอ็นดู","รังเกียจ","ดูถูก","เหยียด","ยอมรับ","ปฏิเสธ","จริงใจ","หลอกลวง","ซื่อสัตย์","ทรยศ","ซาบซึ้ง","ประทับใจ","เขิน","อาย","ประหม่า","โล่งใจ","ตกใจ","สับสน","ลังเล","แน่วแน่","ใจดี","ใจดำ","ใจร้าย","ใจเย็น","ใจร้อน","เกรงใจ","ถ่อมตัว","จองหอง","อวดดี","ดื้อ","ยอม"]
};

let MONOLITH = JSON.parse(localStorage.getItem('LANGE_V95_MEMORY')) || DEFAULT_MONOLITH;

function saveMemory() {
    localStorage.setItem('LANGE_V95_MEMORY', JSON.stringify(MONOLITH));
}

Object.keys(MONOLITH).forEach(c => { 
    while(MONOLITH[c].length < 300) { MONOLITH[c].push(`${c}_Data_Unit_${MONOLITH[c].length}`); } 
});

let currentUser = "";
let lossChart = null;
let dataPoints = 100;
// เริ่มต้นด้วยข้อมูลที่นิ่ง (Static)
let trainData = Array.from({length: dataPoints}, () => 1.0);
let validData = Array.from({length: dataPoints}, () => 1.2);

function checkAccess() {
    const name = document.getElementById('accessName').value.trim();
    if (!name) return;
    currentUser = name;
    document.getElementById('gatekeeper').classList.add('hidden');
    document.getElementById('mainSystem').classList.remove('hidden');
    if (name !== "โตนัส") {
        document.getElementById('adminBar').classList.add('hidden');
        document.getElementById('processTrace').classList.add('hidden');
    }
    renderLearning();
    initLossGraph();
}

function switchMode(mode) {
    ['chat', 'learning', 'graph'].forEach(m => {
        document.getElementById(`btn${m.charAt(0).toUpperCase() + m.slice(1)}`).classList.toggle('active', mode === m);
        document.getElementById(`${m}View`).classList.toggle('hidden', mode !== m);
    });
}

function renderLearning() {
    document.getElementById('vocabList').innerHTML = Object.entries(MONOLITH).map(([cat, words]) => `
        <div class="p-4 bg-black border border-[#30363d] rounded-xl">
            <div class="text-xs font-black text-green-400 mb-3 uppercase tracking-tighter">${cat} (${words.length})</div>
            <div class="v-grid">${words.slice(0, 150).map(w => `<div class="v-item">${w}</div>`).join('')}</div>
        </div>
    `).join('');
}

// --- จุดที่ 2: กราฟขยับเมื่อมีการเพิ่มคำใหม่ลงในหมวด ---
function trainToken() {
    const val = document.getElementById('learnInput').value;
    if (!val.includes("-")) return alert("รูปแบบผิด! ต้องเป็น หมวด-คำใหม่");
    const [cat, word] = val.split("-");
    if (MONOLITH[cat.trim()]) {
        MONOLITH[cat.trim()].push(word.trim());
        saveMemory();
        renderLearning();
        document.getElementById('learnInput').value = "";
        
        // ขยับกราฟเมื่อมีการเรียนรู้ (Spike)
        triggerNeuralActivity(1.5, 0.8);
    } else {
        alert("ไม่พบหมวดหมู่นี้!");
    }
}

function initLossGraph() {
    const ctx = document.getElementById('liveLossChart').getContext('2d');
    lossChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: dataPoints}, (_, i) => i),
            datasets: [
                { label: 'Neural Gain', data: trainData, borderColor: '#58a6ff', backgroundColor: 'rgba(88, 166, 255, 0.1)', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: true },
                { label: 'System Knowledge', data: validData, borderColor: '#00ff88', borderWidth: 2, pointRadius: 0, tension: 0.4 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 200 },
            scales: {
                y: { grid: { color: '#30363d' }, ticks: { display: false }, min: 0, max: 3 },
                x: { display: false }
            },
            plugins: { legend: { labels: { color: '#e6edf3' } } }
        }
    });
}

// ฟังก์ชันหัวใจสำคัญ: ทำให้กราฟขยับตาม "ความรู้" (Triggered Activity)
function triggerNeuralActivity(spike1, spike2) {
    if (!lossChart) return;
    
    // คำนวณฐานความรู้จริงจากจำนวนคำใน MONOLITH
    const totalKnowledge = Object.values(MONOLITH).flat().length / 900;

    trainData.shift(); 
    trainData.push(totalKnowledge + (Math.random() * spike1)); 
    
    validData.shift(); 
    validData.push(totalKnowledge * 0.9 + (Math.random() * spike2));
    
    lossChart.update();
}

async function addTrace(pillar, detail) {
    if (currentUser !== "โตนัส") return;
    const log = document.getElementById('traceLog');
    log.innerHTML += `<div class="trace-line"><strong>${pillar}:</strong> ${detail}</div>`;
    log.scrollTop = log.scrollHeight;
    await new Promise(r => setTimeout(r, 200));
}

// --- จุดที่ 1: กราฟขยับเมื่อมีการพิมพ์แชท (ตามความรู้ที่ตอบ) ---
document.getElementById('chatForm').onsubmit = async (e) => {
    e.preventDefault();
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) return;

    document.getElementById('viewport').innerHTML += `<div class="msg-line user"><div class="bubble">${text}</div></div>`;
    document.getElementById('traceLog').innerHTML = "";
    
    // กราฟขยับเมื่อเริ่มประมวลผล (Signal Spike)
    triggerNeuralActivity(0.5, 0.3);

    await addTrace("TOKENIZE", "Decoding 942-Parameter Nodes...");
    await addTrace("LOCAL-MEMORY", "Accessing Persistent Storage...");
    
    let mathRes = null;
    try { if (/[0-9+\-*/().]{3,}/.test(text)) mathRes = new Function(`return ${text}`)(); } catch(e) {}
    
    const ex = MONOLITH["อุทาน"][Math.floor(Math.random() * 20)];
    let reply = mathRes !== null ? `${ex}! ผลลัพธ์คือ ${mathRes}` : `${ex}! Lange-Model วิเคราะห์เสร็จสิ้น`;

    document.getElementById('viewport').innerHTML += `<div class="msg-line assistant"><div class="bubble">${reply}</div></div>`;
    
    // กราฟขยับอีกครั้งเมื่อตอบเสร็จ (Knowledge Integration)
    triggerNeuralActivity(0.8, 0.5);

    input.value = "";
    document.getElementById('viewport').scrollTop = document.getElementById('viewport').scrollHeight;
};
</script>
</body>
</html>
