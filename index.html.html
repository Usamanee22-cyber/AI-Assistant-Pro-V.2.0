<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Lange-Model V82: Persistent Memory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400&family=Noto+Sans+Thai:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans Thai', sans-serif; box-sizing: border-box; }
        body { background: #010409; color: #e6edf3; height: 100vh; overflow: hidden; }
        .code-font { font-family: 'Fira Code', monospace; }
        .hidden { display: none !important; }
        
        /* UI ใหม่: ไม่เหมือน Line, กล่องข้อความสั้นยาวตามเนื้อหา */
        #viewport, #userViewport { 
            flex: 1; overflow-y: auto; padding: 40px; 
            background: radial-gradient(circle at center, #0d1117 0%, #010409 100%); 
            display: flex; flex-direction: column; gap: 20px; 
        }
        
        .msg-line { display: flex; width: 100%; }
        .assistant { justify-content: flex-start; }
        .user { justify-content: flex-end; }

        .bubble { 
            padding: 12px 18px; 
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
            /* กล่องกว้างตามเนื้อหาแต่ไม่เกิน 75% */
            display: inline-block; 
            max-width: 75%; 
        }

        /* ดีไซน์ AI: ทรงเหลี่ยมมนล้ำสมัย */
        .assistant .bubble { 
            background: #161b22; 
            border-left: 4px solid #238636;
            color: #c9d1d9; 
            border-radius: 0px 15px 15px 15px;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.3);
        }

        /* ดีไซน์ User: เน้นความเรียบหรูแบบ Glassmorphism */
        .user .bubble { 
            background: rgba(35, 134, 54, 0.15); 
            border: 1px solid rgba(35, 134, 54, 0.5);
            color: #4ade80; 
            border-radius: 15px 15px 0px 15px;
            text-align: right;
        }

        .math-box { 
            background: #000 !important; 
            border: 1px solid #10b981 !important; 
            color: #10b981 !important; 
            font-family: 'Fira Code' !important;
            padding: 20px !important;
        }
    </style>
</head>
<body>

<div id="gatekeeper" class="h-full flex flex-col items-center justify-center bg-[#0d1117] p-6">
    <div class="text-center mb-10">
        <div class="w-20 h-20 bg-green-500 rounded-2xl mx-auto mb-6 flex items-center justify-center text-4xl font-black text-black shadow-[0_0_50px_rgba(34,197,94,0.3)]">L</div>
        <h1 class="text-4xl font-black tracking-tight">LANGE <span class="text-green-500">V82</span></h1>
        <p class="text-slate-500 text-xs mt-2 tracking-[0.3em] font-bold">PERSISTENT NEURAL SYSTEM</p>
    </div>
    <div class="w-full max-w-sm space-y-3">
        <input type="text" id="accessName" class="w-full bg-[#161b22] border border-[#30363d] p-4 rounded-xl text-center text-xl font-bold text-white focus:border-green-500 outline-none" placeholder="IDENTITY">
        <button onclick="unlockGate()" class="w-full bg-green-600 text-white p-4 rounded-xl font-black hover:bg-green-500 transition-all">INITIALIZE</button>
    </div>
</div>

<div id="devUI" class="hidden h-full flex flex-col">
    <header class="p-4 border-b border-[#30363d] flex justify-between items-center bg-[#010409]">
        <div class="flex items-center gap-3">
            <span class="animate-ping w-2 h-2 rounded-full bg-green-500"></span>
            <b class="text-xs uppercase tracking-widest font-black text-slate-400">Master Lab <span class="text-green-500">Online</span></b>
        </div>
        <div id="qrcode" class="bg-white p-1 rounded"></div>
    </header>
    <div class="flex flex-1 overflow-hidden">
        <aside class="w-80 bg-[#010409] border-r border-[#30363d] overflow-y-auto p-4 text-[9px] code-font text-slate-500">
            <div class="flex justify-between items-center mb-4 border-b border-[#30363d] pb-2">
                <h3 class="text-green-500 font-black uppercase">Monolith Data</h3>
                <button onclick="resetMemory()" class="text-red-800 hover:text-red-500">[RESET MEMORY]</button>
            </div>
            <div id="fullVocabList"></div>
        </aside>
        <main class="flex-1 flex flex-col">
            <div id="viewport"></div>
            <footer class="p-4 border-t border-[#30363d] bg-[#010409]">
                <form id="devForm" class="flex gap-2">
                    <input type="text" id="devInput" class="flex-1 bg-[#161b22] border border-[#30363d] p-3 rounded-lg text-white text-sm" placeholder="COMMAND: หมวด-คำใหม่">
                    <button class="bg-white text-black px-6 rounded-lg font-black text-sm hover:bg-green-500">EXEC</button>
                </form>
            </footer>
        </main>
    </div>
</div>

<div id="userUI" class="hidden h-full flex flex-col">
    <header class="p-5 border-b border-[#30363d] flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-black font-black text-sm">L</div>
            <h2 class="font-black text-sm tracking-widest">LANGE CORE</h2>
        </div>
    </header>
    <div id="userViewport"></div>
    <footer class="p-6">
        <form id="userForm" class="flex gap-2 max-w-4xl mx-auto w-full">
            <input type="text" id="userInput" class="flex-1 bg-[#161b22] border border-[#30363d] p-4 rounded-2xl text-white outline-none focus:border-green-500" placeholder="ถามสิ่งที่อยากรู้...">
            <button class="bg-green-600 p-4 rounded-2xl text-white font-black hover:bg-green-500">SEND</button>
        </form>
    </footer>
</div>

<script>
// ============================================================
// [คงเดิม: 700 คำศัพท์ ห้ามขาดแม้แต่คำเดียว]
// ============================================================
const DEFAULT_DB = {
    "ทักทาย": ["สวัสดี", "ฮัลโหล", "หวัดดี", "ดีจ้า", "โย่ว", "ไฮ", "กราบ", "สวัสดียามเช้า", "สวัสดียามบ่าย", "สวัสดียามเย็น", "สบายดีไหม", "เป็นยังไงบ้าง", "ไฮฮาย", "ทักทายครับ", "ทักทายค่ะ", "ว่าไง", "ฮัลโหลๆ", "ดีครับ", "ดีค่ะ", "หวัดดีจ้า", "อรุณสวัสดิ์", "ฝันดี", "ราตรีสวัสดิ์", "สวัสดิการ", "ยินดีที่รู้จัก", "เช่นกัน", "โหลๆ", "สวัสดีครับผม", "สวัสดีค่ะคุณ", "ดีดี", "ว่าไงจ๊ะ", "ไง", "โย่วๆ", "ฮายๆ", "เฮลโล", "กราบสวัสดิ์", "ไหว้", "นอบน้อม", "ยินดี", "ทัก", "เซย์ไฮ", "ดีจ่ะ", "หวัดดีคุณ", "ฮัลโหลเทส", "สบายดีนะ", "หวังว่าสบายดี", "ดีครับท่าน", "สวัสสดี", "สวัสดี่", "สวสดี", "สวัสดีเจ้า", "สวัสดีครับท่าน", "ยินดีคัด", "ยินดีรับ", "ทักทายกัน", "สวัสดีทุกคน", "หวัดดีทุกคน", "โย่วคนสวย", "โย่วคนหล่อ", "ดีจ้าคนดี", "ฮัลโหลเพื่อน", "หวัดดีเพื่อน", "ไฮเพื่อน", "กราบเพื่อน", "ทักทายนะ", "ดีดีจ้า", "ฮัลโหลฮาย", "สวัสดีปีใหม่", "สวัสดีสงกรานต์", "สวัสดีวันจันทร์", "สวัสดีวันอังคาร", "สวัสดีวันพุธ", "สวัสดีวันพฤหัส", "สวัสดีวันศุกร์", "สวัสดีวันเสาร์", "สวัสดีวันอาทิตย์", "สวัสดีน้า", "สวัสดีป้า", "สวัสดีลุง", "สวัสดีอา", "สวัสดีพี่", "สวัสดีน้อง", "สวัสดีแก", "สวัสดีมึง", "สวัสดีเรา", "สวัสดีท่าน", "สวัสดีจ้าา", "สวัสดีครับบ", "หวัดดีครับบ", "ดีครับผม", "ดีค่ะผม", "ดีครับท่านผู้นำ", "ดีครับลูกพี่", "สวัสดีลูกพี่", "ทักทายจ้า", "หวัดดีนะจ๊ะ", "ดีจ้าาา", "ฮัลโหลลล", "ไฮยยย", "หวัดดีจ้าาา"],
    "ธุรกิจ": ["ทุน", "กำไร", "ขาดทุน", "งบประมาณ", "หุ้น", "การลงทุน", "ตลาด", "เศรษฐกิจ", "เงินเฟ้อ", "ภาษี", "ธนาคาร", "ดอกเบี้ย", "เงินปันผล", "รายรับ", "รายจ่าย", "บัญชี", "สต็อก", "โกดัง", "ขนส่ง", "โลจิสติกส์", "ส่งออก", "นำเข้า", "การค้า", "สัญญา", "หุ้นส่วน", "นักลงทุน", "ผู้ประกอบการ", "ธุรกิจ", "อุตสาหกรรม", "การผลิต", "บริการ", "ลูกค้า", "พนักงาน", "เงินเดือน", "โบนัส", "คอมมิชชั่น", "ยอดขาย", "การตลาด", "โฆษณา", "แบรนด์", "คู่แข่ง", "เป้าหมาย", "กลยุทธ์", "ความเสี่ยง", "โอกาส", "การจัดการ", "ทรัพยากร", "นวัตกรรม", "เทคโนโลยี", "พัฒนา", "เติบโต", "ขยาย", "ร่วมมือ", "ประมูล", "ราคา", "ส่วนลด", "โปรโมชั่น", "สมาชิก", "ลูกค้าประจำ", "ความพึงพอใจ", "ยอดจอง", "ผลิตผล", "ประสิทธิภาพ", "หนี้สิน", "เครดิต", "การกู้ยืม", "ค้ำประกัน", "ประกันภัย", "สินทรัพย์", "ที่ดิน", "โรงงาน", "เครื่องจักร", "มูลค่า", "ประเมิน", "วิเคราะห์", "ข้อมูล", "รายงาน", "การประชุม", "มติ", "กฎหมาย", "ข้อบังคับ", "ระเบียบ", "นโยบาย", "วางแผน", "การเงิน", "การธนาคาร", "บัญชีธนาคาร", "เช็ค", "เงินสด", "บัตรเครดิต", "โอนเงิน", "ชำระเงิน", "บิล", "ใบเสร็จ", "ใบกำกับภาษี", "ส่งของ", "รับของ", "คืนเงิน", "แลกเปลี่ยน"],
    "สัตว์": ["หมา", "แมว", "เสือ", "สิงโต", "ช้าง", "ม้า", "วัว", "ควาย", "ลิง", "นก", "ปลา", "กุ้ง", "หอย", "ปู", "เป็ด", "ไก่", "หมี", "กระต่าย", "หนู", "งู", "กบ", "เต่า", "จระเข้", "ยมทูต", "แมลง", "ผึ้ง", "มด", "แมงมุม", "แมลงวัน", "ยุง", "ผีเสื้อ", "ค้างคาว", "กวาง", "เก้ง", "หมู", "แพะ", "แกะ", "อูฐ", "ยีราฟ", "ม้าลาย", "แรด", "ฮิปโป", "จิงโจ้", "เพนกวิน", "นกยูง", "นกอินทรี", "นกฮูก", "เป็ดเทศ", "ห่าน", "ไก่งวง", "ปลาทอง", "ปลาคาร์พ", "ปลาฉลาม", "ปลาวาฬ", "โลมา", "แมวน้ำ", "สิงโตทะเล", "วอลรัส", "ปลาหมึก", "ม้าน้ำ", "กุ้งมังกร", "กุ้งฝอย", "หอยทาก", "หอยเชลล์", "ปูดำ", "ปูม้า", "ปูนา", "ปลวก", "ตะขาบ", "แมงป่อง", "กิ้งกือ", "จิ้งจก", "ตุ๊กแก", "กิ้งก่า", "คางคก", "เขียด", "อึ่งอ่าง", "พะยูน", "ตุ่นปากเป็ด", "ตัวเงินตัวทอง", "ตะกวด", "อีเก้ง", "ละมั่ง", "กระทิง", "กูปรอย", "นกเขา", "นกเอี้ยง", "นกขุนทอง", "นกกระจอก", "นกกระจิบ", "นกพิราบ", "นกนางนวล", "นกนางแอ่น", "นกกระจอกเทศ", "นกกระเรียน", "นกกระยาง", "นกกระทุง", "นกกระสา"],
    "คุยเล่น": ["เหงา", "ตลก", "ขำ", "สนุก", "เบื่อ", "เซ็ง", "ไปไหนดี", "กินไรดี", "ทำไรอยู่", "จริงหรอ", "สุดยอด", "เทพ", "เก่ง", "น่ารัก", "ชอบ", "รัก", "ดีใจ", "เสียใจ", "โกรธ", "หิว", "ง่วง", "นอน", "ตื่น", "อาบน้ำ", "แต่งตัว", "ไปเที่ยว", "ดูหนัง", "ฟังเพลง", "เล่นเกม", "คุยกัน", "เม้าท์", "นินทา", "คิดถึง", "อยากเจอ", "ฝัน", "จินตนาการ", "สวย", "หล่อ", "เท่", "เท่ๆ", "แนว", "วัยรุ่น", "สไตล์", "แฟชั่น", "ดารา", "เพลง", "คอนเสิร์ต", "อารมณ์", "ความรู้สึก", "เพื่อน", "พี่น้อง", "ครอบครัว", "แฟน", "คนคุย", "โสด", "เหงาๆ", "เศร้า", "น้ำตา", "ยิ้ม", "หัวเราะ", "ฮ่าๆ", "อิอิ", "อุ๊ย", "อัยย่ะ", "ว้าว", "โอ้โห", "พระเจ้า", "เหลือเชื่อ", "ประหลาด", "แปลก", "มหัศจรรย์", "ลึกลับ", "ปริศนา", "ท้าทาย", "คำถาม", "คำตอบ", "คุยได้", "ถามได้", "ตอบได้", "เก่งจัง", "ฉลาดจัง", "โง่", "บ้า", "บอ", "ไร้สาระ", "สาระ", "ความรู้", "เกร็ด", "เคล็ดลับ", "วิธีการ", "ลองดู", "สู้ๆ", "พยายาม", "อดทน", "ตั้งใจ", "ความหวัง", "ความเชื่อ", "ความดี", "บุญ", "บาป", "โชคดี", "โชคร้าย"],
    "คณิต": ["บวก", "ลบ", "คูณ", "หาร", "เท่ากับ", "สมการ", "โจทย์", "ตัวเลข", "เลข", "เปอร์เซ็นต์", "ร้อยละ", "ถอนราก", "สแควรูท", "ยกกำลัง", "เลขชี้กำลัง", "เศษส่วน", "ทศนิยม", "วงเล็บ", "ค่าคงที่", "ตัวแปร", "พีชคณิต", "ตรีโกณ", "แคลคูลัส", "สถิติ", "ความน่าจะเป็น", "กราฟ", "พิกัด", "มุม", "องศา", "เรเดียน", "วงกลม", "สามเหลี่ยม", "สี่เหลี่ยม", "พื้นที่", "ปริมาตร", "เส้นรอบรูป", "รัศมี", "เส้นผ่านศูนย์กลาง", "ด้าน", "ฐาน", "สูง", "ยาว", "กว้าง", "ลึก", "น้ำหนัก", "ปริมาณ", "ระยะทาง", "เวลา", "ความเร็ว", "ความเร่ง", "มวล", "แรง", "พลังงาน", "งาน", "ความดัน", "อุณหภูมิ", "กระแส", "แรงดัน", "ความต้านทาน", "ตัวเลขไทย", "เลขโรมัน", "ฐานสอง", "ฐานสิบ", "ฐานสิบหก", "ตรรกศาสตร์", "และ", "หรือ", "ไม่", "ถ้าแล้ว", "ก็ต่อเมื่อ", "เซต", "สมาชิก", "ยูเนียน", "อินเตอร์เซกชัน", "ฟังก์ชัน", "โดเมน", "เรนจ์", "ลิมิต", "อนุพันธ์", "อินทิเกรต", "เมทริกซ์", "ดีเทอร์มิแนนต์", "เวกเตอร์", "ขนาด", "ทิศทาง", "จุด", "เส้นตรง", "ระนาบ", "มิติ", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า", "สิบ"],
    "ปรึกษา": ["แนะนำ", "ปรึกษา", "ช่วยเหลือ", "ทางออก", "วิธี", "ขั้นตอน", "ทำยังไง", "อยากรู้", "ขอถาม", "ช่วยบอก", "ช่วยสอน", "เรียน", "ศึกษา", "พัฒนา", "แก้ไข", "ปรับปรุง", "สร้าง", "ทำ", "ออกแบบ", "วางแผน", "เป้าหมาย", "ความสำเร็จ", "ล้มเหลว", "ปัญหา", "อุปสรรค", "จัดการ", "บริหาร", "เวลา", "ชีวิต", "อนาคต", "การงาน", "การเรียน", "สุขภาพ", "จิตใจ", "ความเครียด", "วิตกกังวล", "โรค", "ยา", "รักษา", "หมอ", "พยาบาล", "โรงพยาบาล", "ความรัก", "ความสัมพันธ์", "แต่งงาน", "หย่า", "ลูก", "พ่อแม่", "เพื่อนบ้าน", "สังคม", "การเมือง", "กฎหมาย", "สิทธิ", "หน้าที่", "ความรับผิดชอบ", "ศีลธรรม", "จริยธรรม", "ศาสนา", "ความเชื่อ", "จิตวิญญาณ", "สมาธิ", "สติ", "ปัญญา", "ความสุข", "ความสงบ", "แรงบันดาลใจ", "กำลังใจ", "แนวทาง", "เลือก", "ตัดสินใจ", "ผลกระทบ", "ความเสี่ยง", "ปลอดภัย", "อันตราย", "ระวัง", "ป้องกัน", "เตรียมตัว", "พร้อม", "โอกาส", "ประสบการณ์", "บทเรียน", "ความผิดพลาด", "ขอโทษ", "ขอบคุณ", "ยินดี", "แบ่งปัน", "บริจาค", "จิตอาสา", "ช่วยเหลือสังคม", "สิ่งแวดล้อม", "ภาวะโลกร้อน", "ประหยัด", "พลังงาน", "ทรัพยากร", "ยั่งยืน", "พอเพียง"],
    "อิสระ": ["อวกาศ", "ท้องฟ้า", "ดวงดาว", "จักรวาล", "โลก", "ดวงจันทร์", "ดวงอาทิตย์", "กาแล็กซี", "มนุษย์ต่างดาว", "ยูเอฟโอ", "อนาคต", "หุ่นยนต์", "เอไอ", "ปัญญาประดิษฐ์", "ความฝัน", "จินตนาการ", "สีสัน", "ดนตรี", "ศิลปะ", "ภาพวาด", "กวี", "นิยาย", "การ์ตูน", "เกม", "กีฬา", "ฟุตบอล", "บาสเกตบอล", "เทนนิส", "ว่ายน้ำ", "วิ่ง", "ปีนเขา", "ทะเล", "น้ำตก", "ป่าไม้", "ภูเขา", "ทุ่งหญ้า", "ดอกไม้", "ต้นไม้", "ก้อนเมฆ", "สายฝน", "พายุ", "หิมะ", "หนาว", "ร้อน", "อบอุ่น", "ลม", "แสงแดด", "รุ้งกินน้ำ", "ความหวัง", "เสรีภาพ", "อิสรภาพ", "สันติภาพ", "ความเท่าเทียม", "ความยุติธรรม", "ประวัติศาสตร์", "วัฒนธรรม", "ประเพณี", "โบราณ", "ทันสมัย", "ล้ำยุค", "ลึกลับ", "ปริศนา", "เวทมนตร์", "ปาฏิหาริย์", "เหนือธรรมชาติ", "วิญญาณ", "ผี", "นรก", "สวรรค์", "โชคชะตา", "พรหมลิขิต", "กาลเวลา", "มิติที่สี่", "ความว่างเปล่า", "จุดเริ่มต้น", "จุดจบ", "นิรันดร์", "การเดินทาง", "ผจญภัย", "แผนที่", "เข็มทิศ", "เรือ", "เครื่องบิน", "รถยนต์", "รถไฟ", "จักรยาน", "เทคโนโลยี", "ความล้ำ", "สิ่งประดิษฐ์", "การค้นพบ", "ความจริง", "ความลี้ลับ", "แสง", "เสียง", "สัมผัส", "รสชาติ", "กลิ่น", "ชีวิต"]
};

// ============================================================
// [ระบบ NATURAL SYNTHESIS & 15 PILLARS]
// ============================================================
const CHAT_STYLE = {
    "ทักทาย": ["สวัสดีครับ! วันนี้ Lange มีอะไรให้ช่วยไหม?", "โอ้ สวัสดีครับ! ดีใจที่ได้คุยกันนะ", "หวัดดีครับ! กำลังรอคำถามอยู่เลย"],
    "ธุรกิจ": ["เรื่องธุรกิจนี่น่าสนใจนะครับ", "ข้อมูลส่วนนี้ Lange จะช่วยวิเคราะห์ให้เองครับ", "มาวางแผนให้เติบโตไปด้วยกันเถอะ"],
    "สัตว์": ["สัตว์โลกน่ารักเสมอเลยนะครับ", "Lange ชอบหัวข้อเรื่องสัตว์มากเลยล่ะ", "สายพันธุ์นี้มีความพิเศษจริงๆ ครับ"],
    "คุยเล่น": ["ฮ่าๆ คุยกันสนุกดีนะครับ", "ผมชอบอารมณ์ขันของคุณจัง", "Lange พร้อมคุยเล่นเป็นเพื่อนเสมอครับ"],
    "ปรึกษา": ["เข้าใจเลยครับ Lange จะลองหาทางออกให้นะ", "เรื่องนี้เรามาช่วยกันคิดทีละสเต็ปนะครับ", "ปรึกษาได้ทุกเมื่อเลย Lange พร้อมรับฟังครับ"],
    "อิสระ": ["เป็นหัวข้อที่ล้ำลึกมากครับ", "โลกและจักรวาลนี้ยังมีเรื่องน่าทึ่งอีกเยอะเลย", "ขอบคุณที่แชร์ไอเดียดีๆ แบบนี้กับ Lange นะ"]
};

class PersistentLangeEngine {
    constructor() {
        // [ระบบจำถาวร]: โหลดจาก LocalStorage หรือใช้ Default
        const saved = localStorage.getItem('LANGE_CORE_DB');
        this.vocab = saved ? JSON.parse(saved) : DEFAULT_DB;
        this.pillars = ["P1_Tokenize", "P2_Vector", "P3_BigLang", "P4_Math", "P5_Sentiment", "P6_ML", "P7_Deep", "P8_Train", "P9_Param", "P10_Context", "P11_Logic", "P12_Sensory", "P13_DB", "P14_Tech", "P15_Synthesize"];
    }

    save() {
        localStorage.setItem('LANGE_CORE_DB', JSON.stringify(this.vocab));
    }

    solveMath(expr) {
        try {
            const clean = expr.replace(/[^-+/*()0-9.]/g, '');
            if(!clean) return null;
            return Function(`'use strict'; return (${clean})`)();
        } catch(e) { return null; }
    }

    process(text, isDev) {
        // เทรนคำศัพท์ใหม่ (Admin Only)
        if(isDev && text.includes('-')) {
            const [cat, word] = text.split('-').map(s => s.trim());
            if(this.vocab[cat]) {
                this.vocab[cat].push(word);
                this.save(); // บันทึกถาวรลงเครื่อง
                return { reply: `[SYSTEM] จดจำคำว่า "${word}" ลงในหมวด "${cat}" เรียบร้อยแล้วครับ! (บันทึกถาวร)`, isDev: true };
            }
        }

        const math = this.solveMath(text);
        if(math !== null) return { reply: `จากการคำนวณอย่างแม่นยำ ผลลัพธ์ที่ได้คือ ${math} ครับ`, isMath: true };

        let foundCat = null;
        for(let cat in this.vocab) {
            if(this.vocab[cat].some(w => text.includes(w))) { foundCat = cat; break; }
        }

        if(foundCat && CHAT_STYLE[foundCat]) {
            return { reply: CHAT_STYLE[foundCat][Math.floor(Math.random() * CHAT_STYLE[foundCat].length)] };
        }
        
        return { reply: "Lange กำลังเรียนรู้ข้อมูลส่วนนี้นะครับ ช่วยเล่ารายละเอียดให้ฟังเพิ่มได้ไหม?" };
    }
}

const engine = new PersistentLangeEngine();
const HUB_ID = "LANGE_NET_V82";
let peer, conn, connections = [];

function unlockGate() {
    const name = document.getElementById('accessName').value.trim();
    if(!name) return;
    document.getElementById('gatekeeper').classList.add('hidden');
    if(name === "โตนัส") {
        document.getElementById('devUI').classList.remove('hidden');
        renderFullVocab();
        peer = new Peer(HUB_ID);
        peer.on('open', id => new QRCode(document.getElementById("qrcode"), {text:id, width:40, height:40}));
        peer.on('connection', c => { connections.push(c); c.on('open', () => sync()); });
    } else {
        document.getElementById('userUI').classList.remove('hidden');
        peer = new Peer();
        setInterval(() => { if(!conn) { conn = peer.connect(HUB_ID); conn.on('data', d => { if(d.db) engine.vocab = d.db; }); } }, 2000);
    }
}

function renderFullVocab() {
    const list = document.getElementById('fullVocabList');
    list.innerHTML = Object.entries(engine.vocab).map(([cat, words]) => `
        <div class="mb-4">
            <h4 class="text-green-500 font-black mb-1">${cat} (${words.length})</h4>
            <div class="flex flex-wrap gap-1 border-l border-[#30363d] pl-2">${words.map(w => `<span>${w}</span>`).join(' ')}</div>
        </div>
    `).join('');
}

function resetMemory() {
    if(confirm("ต้องการล้างข้อมูลที่เทรนมาทั้งหมดและใช้ค่าเริ่มต้นใช่หรือไม่?")) {
        localStorage.removeItem('LANGE_CORE_DB');
        location.reload();
    }
}

function sync() {
    connections.forEach(c => c.send({ db: engine.vocab }));
}

const handleChat = (formId, inputId, viewId, isDev) => {
    document.getElementById(formId).onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById(inputId);
        if(!input.value) return;
        
        const res = engine.process(input.value, isDev);
        const view = document.getElementById(viewId);
        
        view.innerHTML += `
            <div class="msg-line user"><div class="bubble">${input.value}</div></div>
            <div class="msg-line assistant"><div class="bubble ${res.isMath ? 'math-box' : ''}">
                ${res.reply}
                ${isDev ? `<div class="mt-2 pt-2 border-t border-[#30363d] text-[7px] opacity-30 tracking-tighter uppercase">${engine.pillars.join(' • ')}</div>` : ''}
            </div></div>`;
            
        input.value = "";
        view.scrollTop = view.scrollHeight;
        if(isDev) { renderFullVocab(); sync(); }
    };
}

handleChat('devForm', 'devInput', 'viewport', true);
handleChat('userForm', 'userInput', 'userViewport', false);
</script>
</body>
</html>
