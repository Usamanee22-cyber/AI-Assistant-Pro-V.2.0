<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Lange-Model V81: Natural Voice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400&family=Noto+Sans+Thai:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans Thai', sans-serif; box-sizing: border-box; }
        body { background: #010409; color: #e6edf3; height: 100vh; overflow: hidden; }
        .code-font { font-family: 'Fira Code', monospace; }
        .hidden { display: none !important; }
        #viewport, #userViewport { flex: 1; overflow-y: auto; padding: 25px; background: #0d1117; display: flex; flex-direction: column; gap: 15px; }
        .bubble { padding: 14px 20px; border-radius: 22px; max-width: 80%; line-height: 1.6; }
        .assistant .bubble { background: #161b22; border: 1px solid #30363d; color: #c9d1d9; border-bottom-left-radius: 4px; }
        .user .bubble { background: #238636; color: white; margin-left: auto; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(35, 134, 54, 0.2); }
        .math-box { background: #000; border: 1px solid #10b981; color: #10b981; padding: 10px; border-radius: 10px; font-family: 'Fira Code'; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<div id="gatekeeper" class="h-full flex flex-col items-center justify-center bg-[#0d1117] p-6">
    <div class="text-center mb-10 scale-110">
        <div class="w-24 h-24 bg-gradient-to-tr from-green-600 to-green-400 rounded-[30px] mx-auto mb-6 flex items-center justify-center text-5xl font-black text-black shadow-2xl">L</div>
        <h1 class="text-5xl font-black tracking-tighter">LANGE <span class="text-green-500">V81</span></h1>
        <p class="text-slate-500 font-bold mt-2 tracking-[0.2em]">NEURAL NETWORK SYSTEM</p>
    </div>
    <div class="w-full max-w-sm space-y-4">
        <input type="text" id="accessName" class="w-full bg-[#161b22] border border-[#30363d] p-5 rounded-3xl text-center text-2xl font-bold text-white focus:border-green-500 outline-none transition-all" placeholder="IDENTIFY YOURSELF">
        <button onclick="unlockGate()" class="w-full bg-white text-black p-5 rounded-3xl font-black text-xl hover:bg-green-500 transition-colors">ACCESS SYSTEM</button>
    </div>
</div>

<div id="devUI" class="hidden h-full flex flex-col bg-[#0d1117]">
    <header class="p-4 border-b border-[#30363d] flex justify-between items-center bg-[#010409]">
        <div class="flex items-center gap-3">
            <span class="animate-pulse status-dot bg-red-500"></span>
            <b class="text-lg uppercase tracking-widest font-black">Admin <span class="text-green-500">Master-Lab</span></b>
        </div>
        <div id="qrcode" class="bg-white p-1 rounded-sm"></div>
    </header>
    <div class="flex flex-1 overflow-hidden">
        <aside class="w-96 bg-[#010409] border-r border-[#30363d] overflow-y-auto p-4 text-[10px] code-font text-slate-500">
            <h3 class="text-green-500 font-black mb-4 border-b border-[#30363d] pb-2 uppercase italic">Data Monolith: 700 Words</h3>
            <div id="fullVocabList"></div>
        </aside>
        <main class="flex-1 flex flex-col">
            <div id="viewport"></div>
            <footer class="p-6 border-t border-[#30363d] bg-[#010409]">
                <form id="devForm" class="flex gap-2">
                    <input type="text" id="devInput" class="flex-1 bg-[#161b22] border border-[#30363d] p-4 rounded-xl text-white" placeholder="พิมพ์ถาม หรือ 'หมวด-คำใหม่'...">
                    <button class="bg-green-600 px-10 rounded-xl font-black hover:bg-green-500">EXECUTE</button>
                </form>
            </footer>
        </main>
    </div>
</div>

<div id="monitorUI" class="hidden h-full bg-black p-10 flex flex-col">
    <h2 class="text-3xl font-black text-white mb-6 uppercase tracking-widest">Neural Learning Curve</h2>
    <div class="flex-1 bg-[#0d1117] rounded-[50px] border border-[#30363d] p-8 relative">
        <svg width="100%" height="100%" viewBox="0 0 1000 400" preserveAspectRatio="none">
            <path id="pathAcc" d="M 0 400" stroke="#388bfd" stroke-width="5" fill="none" style="transition: 1s;"></path>
            <path id="pathLoss" d="M 0 50" stroke="#f85149" stroke-width="5" fill="none" style="transition: 1s;"></path>
        </svg>
    </div>
</div>

<div id="userUI" class="hidden h-full flex flex-col bg-[#0d1117]">
    <header class="p-6 bg-[#010409] border-b border-[#30363d] flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center text-black font-black">L</div>
            <div>
                <h2 class="font-black text-lg">Lange AI</h2>
                <p class="text-[10px] text-green-500 uppercase tracking-widest font-bold">Online & Adaptive</p>
            </div>
        </div>
    </header>
    <div id="userViewport"></div>
    <footer class="p-6 bg-[#010409] border-t border-[#30363d]">
        <form id="userForm" class="flex gap-3">
            <input type="text" id="userInput" class="flex-1 bg-[#161b22] border border-[#30363d] p-4 rounded-2xl text-white text-lg" placeholder="ถามอะไร Lange ก็ได้นะ...">
            <button class="bg-green-600 px-8 rounded-2xl font-black shadow-lg shadow-green-900/20">ส่ง</button>
        </form>
    </footer>
</div>

<script>
// ============================================================
// [คงเดิม: 700 คำศัพท์ ห้ามขาดแม้แต่คำเดียว]
// ============================================================
const MASTER_DB = {
    "ทักทาย": ["สวัสดี", "ฮัลโหล", "หวัดดี", "ดีจ้า", "โย่ว", "ไฮ", "กราบ", "สวัสดียามเช้า", "สวัสดียามบ่าย", "สวัสดียามเย็น", "สบายดีไหม", "เป็นยังไงบ้าง", "ไฮฮาย", "ทักทายครับ", "ทักทายค่ะ", "ว่าไง", "ฮัลโหลๆ", "ดีครับ", "ดีค่ะ", "หวัดดีจ้า", "อรุณสวัสดิ์", "ฝันดี", "ราตรีสวัสดิ์", "สวัสดิการ", "ยินดีที่รู้จัก", "เช่นกัน", "โหลๆ", "สวัสดีครับผม", "สวัสดีค่ะคุณ", "ดีดี", "ว่าไงจ๊ะ", "ไง", "โย่วๆ", "ฮายๆ", "เฮลโล", "กราบสวัสดิ์", "ไหว้", "นอบน้อม", "ยินดี", "ทัก", "เซย์ไฮ", "ดีจ่ะ", "หวัดดีคุณ", "ฮัลโหลเทส", "สบายดีนะ", "หวังว่าสบายดี", "ดีครับท่าน", "สวัสสดี", "สวัสดี่", "สวสดี", "สวัสดีเจ้า", "สวัสดีครับท่าน", "ยินดีคัด", "ยินดีรับ", "ทักทายกัน", "สวัสดีทุกคน", "หวัดดีทุกคน", "โย่วคนสวย", "โย่วคนหล่อ", "ดีจ้าคนดี", "ฮัลโหลเพื่อน", "หวัดดีเพื่อน", "ไฮเพื่อน", "กราบเพื่อน", "ทักทายนะ", "ดีดีจ้า", "ฮัลโหลฮาย", "สวัสดีปีใหม่", "สวัสดีสงกรานต์", "สวัสดีวันจันทร์", "สวัสดีวันอังคาร", "สวัสดีวันพุธ", "สวัสดีวันพฤหัส", "สวัสดีวันศุกร์", "สวัสดีวันเสาร์", "สวัสดีวันอาทิตย์", "สวัสดีน้า", "สวัสดีป้า", "สวัสดีลุง", "สวัสดีอา", "สวัสดีพี่", "สวัสดีน้อง", "สวัสดีแก", "สวัสดีมึง", "สวัสดีเรา", "สวัสดีท่าน", "สวัสดีจ้าา", "สวัสดีครับบ", "หวัดดีครับบ", "ดีครับผม", "ดีค่ะผม", "ดีครับท่านผู้นำ", "ดีครับลูกพี่", "สวัสดีลูกพี่", "ทักทายจ้า", "หวัดดีนะจ๊ะ", "ดีจ้าาา", "ฮัลโหลลล", "ไฮยยย", "หวัดดีจ้าาา"],
    "ธุรกิจ": ["ทุน", "กำไร", "ขาดทุน", "งบประมาณ", "หุ้น", "การลงทุน", "ตลาด", "เศรษฐกิจ", "เงินเฟ้อ", "ภาษี", "ธนาคาร", "ดอกเบี้ย", "เงินปันผล", "รายรับ", "รายจ่าย", "บัญชี", "สต็อก", "โกดัง", "ขนส่ง", "โลจิสติกส์", "ส่งออก", "นำเข้า", "การค้า", "สัญญา", "หุ้นส่วน", "นักลงทุน", "ผู้ประกอบการ", "ธุรกิจ", "อุตสาหกรรม", "การผลิต", "บริการ", "ลูกค้า", "พนักงาน", "เงินเดือน", "โบนัส", "คอมมิชชั่น", "ยอดขาย", "การตลาด", "โฆษณา", "แบรนด์", "คู่แข่ง", "เป้าหมาย", "กลยุทธ์", "ความเสี่ยง", "โอกาส", "การจัดการ", "ทรัพยากร", "นวัตกรรม", "เทคโนโลยี", "พัฒนา", "เติบโต", "ขยาย", "ร่วมมือ", "ประมูล", "ราคา", "ส่วนลด", "โปรโมชั่น", "สมาชิก", "ลูกค้าประจำ", "ความพึงพอใจ", "ยอดจอง", "ผลิตผล", "ประสิทธิภาพ", "หนี้สิน", "เครดิต", "การกู้ยืม", "ค้ำประกัน", "ประกันภัย", "สินทรัพย์", "ที่ดิน", "โรงงาน", "เครื่องจักร", "มูลค่า", "ประเมิน", "วิเคราะห์", "ข้อมูล", "รายงาน", "การประชุม", "มติ", "กฎหมาย", "ข้อบังคับ", "ระเบียบ", "นโยบาย", "วางแผน", "การเงิน", "การธนาคาร", "บัญชีธนาคาร", "เช็ค", "เงินสด", "บัตรเครดิต", "โอนเงิน", "ชำระเงิน", "บิล", "ใบเสร็จ", "ใบกำกับภาษี", "ส่งของ", "รับของ", "คืนเงิน", "แลกเปลี่ยน"],
    "สัตว์": ["หมา", "แมว", "เสือ", "สิงโต", "ช้าง", "ม้า", "วัว", "ควาย", "ลิง", "นก", "ปลา", "กุ้ง", "หอย", "ปู", "เป็ด", "ไก่", "หมี", "กระต่าย", "หนู", "งู", "กบ", "เต่า", "จระเข้", "ยมทูต", "แมลง", "ผึ้ง", "มด", "แมงมุม", "แมลงวัน", "ยุง", "ผีเสื้อ", "ค้างคาว", "กวาง", "เก้ง", "หมู", "แพะ", "แกะ", "อูฐ", "ยีราฟ", "ม้าลาย", "แรด", "ฮิปโป", "จิงโจ้", "เพนกวิน", "นกยูง", "นกอินทรี", "นกฮูก", "เป็ดเทศ", "ห่าน", "ไก่งวง", "ปลาทอง", "ปลาคาร์พ", "ปลาฉลาม", "ปลาวาฬ", "โลมา", "แมวน้ำ", "สิงโตทะเล", "วอลรัส", "ปลาหมึก", "ม้าน้ำ", "กุ้งมังกร", "กุ้งฝอย", "หอยทาก", "หอยเชลล์", "ปูดำ", "ปูม้า", "ปูนา", "ปลวก", "ตะขาบ", "แมงป่อง", "กิ้งกือ", "จิ้งจก", "ตุ๊กแก", "กิ้งก่า", "คางคก", "เขียด", "อึ่งอ่าง", "พะยูน", "ตุ่นปากเป็ด", "ตัวเงินตัวทอง", "ตะกวด", "อีเก้ง", "ละมั่ง", "กระทิง", "กูปรอย", "นกเขา", "นกเอี้ยง", "นกขุนทอง", "นกกระจอก", "นกกระจิบ", "นกพิราบ", "นกนางนวล", "นกนางแอ่น", "นกกระจอกเทศ", "นกกระเรียน", "นกกระยาง", "นกกระทุง", "นกกระสา"],
    "คุยเล่น": ["เหงา", "ตลก", "ขำ", "สนุก", "เบื่อ", "เซ็ง", "ไปไหนดี", "กินไรดี", "ทำไรอยู่", "จริงหรอ", "สุดยอด", "เทพ", "เก่ง", "น่ารัก", "ชอบ", "รัก", "ดีใจ", "เสียใจ", "โกรธ", "หิว", "ง่วง", "นอน", "ตื่น", "อาบน้ำ", "แต่งตัว", "ไปเที่ยว", "ดูหนัง", "ฟังเพลง", "เล่นเกม", "คุยกัน", "เม้าท์", "นินทา", "คิดถึง", "อยากเจอ", "ฝัน", "จินตนาการ", "สวย", "หล่อ", "เท่", "เท่ๆ", "แนว", "วัยรุ่น", "สไตล์", "แฟชั่น", "ดารา", "เพลง", "คอนเสิร์ต", "อารมณ์", "ความรู้สึก", "เพื่อน", "พี่น้อง", "ครอบครัว", "แฟน", "คนคุย", "โสด", "เหงาๆ", "เศร้า", "น้ำตา", "ยิ้ม", "หัวเราะ", "ฮ่าๆ", "อิอิ", "อุ๊ย", "อัยย่ะ", "ว้าว", "โอ้โห", "พระเจ้า", "เหลือเชื่อ", "ประหลาด", "แปลก", "มหัศจรรย์", "ลึกลับ", "ปริศนา", "ท้าทาย", "คำถาม", "คำตอบ", "คุยได้", "ถามได้", "ตอบได้", "เก่งจัง", "ฉลาดจัง", "โง่", "บ้า", "บอ", "ไร้สาระ", "สาระ", "ความรู้", "เกร็ด", "เคล็ดลับ", "วิธีการ", "ลองดู", "สู้ๆ", "พยายาม", "อดทน", "ตั้งใจ", "ความหวัง", "ความเชื่อ", "ความดี", "บุญ", "บาป", "โชคดี", "โชคร้าย"],
    "คณิต": ["บวก", "ลบ", "คูณ", "หาร", "เท่ากับ", "สมการ", "โจทย์", "ตัวเลข", "เลข", "เปอร์เซ็นต์", "ร้อยละ", "ถอนราก", "สแควรูท", "ยกกำลัง", "เลขชี้กำลัง", "เศษส่วน", "ทศนิยม", "วงเล็บ", "ค่าคงที่", "ตัวแปร", "พีชคณิต", "ตรีโกณ", "แคลคูลัส", "สถิติ", "ความน่าจะเป็น", "กราฟ", "พิกัด", "มุม", "องศา", "เรเดียน", "วงกลม", "สามเหลี่ยม", "สี่เหลี่ยม", "พื้นที่", "ปริมาตร", "เส้นรอบรูป", "รัศมี", "เส้นผ่านศูนย์กลาง", "ด้าน", "ฐาน", "สูง", "ยาว", "กว้าง", "ลึก", "น้ำหนัก", "ปริมาณ", "ระยะทาง", "เวลา", "ความเร็ว", "ความเร่ง", "มวล", "แรง", "พลังงาน", "งาน", "ความดัน", "อุณหภูมิ", "กระแส", "แรงดัน", "ความต้านทาน", "ตัวเลขไทย", "เลขโรมัน", "ฐานสอง", "ฐานสิบ", "ฐานสิบหก", "ตรรกศาสตร์", "และ", "หรือ", "ไม่", "ถ้าแล้ว", "ก็ต่อเมื่อ", "เซต", "สมาชิก", "ยูเนียน", "อินเตอร์เซกชัน", "ฟังก์ชัน", "โดเมน", "เรนจ์", "ลิมิต", "อนุพันธ์", "อินทิเกรต", "เมทริกซ์", "ดีเทอร์มิแนนต์", "เวกเตอร์", "ขนาด", "ทิศทาง", "จุด", "เส้นตรง", "ระนาบ", "มิติ", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า", "สิบ"],
    "ปรึกษา": ["แนะนำ", "ปรึกษา", "ช่วยเหลือ", "ทางออก", "วิธี", "ขั้นตอน", "ทำยังไง", "อยากรู้", "ขอถาม", "ช่วยบอก", "ช่วยสอน", "เรียน", "ศึกษา", "พัฒนา", "แก้ไข", "ปรับปรุง", "สร้าง", "ทำ", "ออกแบบ", "วางแผน", "เป้าหมาย", "ความสำเร็จ", "ล้มเหลว", "ปัญหา", "อุปสรรค", "จัดการ", "บริหาร", "เวลา", "ชีวิต", "อนาคต", "การงาน", "การเรียน", "สุขภาพ", "จิตใจ", "ความเครียด", "วิตกกังวล", "โรค", "ยา", "รักษา", "หมอ", "พยาบาล", "โรงพยาบาล", "ความรัก", "ความสัมพันธ์", "แต่งงาน", "หย่า", "ลูก", "พ่อแม่", "เพื่อนบ้าน", "สังคม", "การเมือง", "กฎหมาย", "สิทธิ", "หน้าที่", "ความรับผิดชอบ", "ศีลธรรม", "จริยธรรม", "ศาสนา", "ความเชื่อ", "จิตวิญญาณ", "สมาธิ", "สติ", "ปัญญา", "ความสุข", "ความสงบ", "แรงบันดาลใจ", "กำลังใจ", "แนวทาง", "เลือก", "ตัดสินใจ", "ผลกระทบ", "ความเสี่ยง", "ปลอดภัย", "อันตราย", "ระวัง", "ป้องกัน", "เตรียมตัว", "พร้อม", "โอกาส", "ประสบการณ์", "บทเรียน", "ความผิดพลาด", "ขอโทษ", "ขอบคุณ", "ยินดี", "แบ่งปัน", "บริจาค", "จิตอาสา", "ช่วยเหลือสังคม", "สิ่งแวดล้อม", "ภาวะโลกร้อน", "ประหยัด", "พลังงาน", "ทรัพยากร", "ยั่งยืน", "พอเพียง"],
    "อิสระ": ["อวกาศ", "ท้องฟ้า", "ดวงดาว", "จักรวาล", "โลก", "ดวงจันทร์", "ดวงอาทิตย์", "กาแล็กซี", "มนุษย์ต่างดาว", "ยูเอฟโอ", "อนาคต", "หุ่นยนต์", "เอไอ", "ปัญญาประดิษฐ์", "ความฝัน", "จินตนาการ", "สีสัน", "ดนตรี", "ศิลปะ", "ภาพวาด", "กวี", "นิยาย", "การ์ตูน", "เกม", "กีฬา", "ฟุตบอล", "บาสเกตบอล", "เทนนิส", "ว่ายน้ำ", "วิ่ง", "ปีนเขา", "ทะเล", "น้ำตก", "ป่าไม้", "ภูเขา", "ทุ่งหญ้า", "ดอกไม้", "ต้นไม้", "ก้อนเมฆ", "สายฝน", "พายุ", "หิมะ", "หนาว", "ร้อน", "อบอุ่น", "ลม", "แสงแดด", "รุ้งกินน้ำ", "ความหวัง", "เสรีภาพ", "อิสรภาพ", "สันติภาพ", "ความเท่าเทียม", "ความยุติธรรม", "ประวัติศาสตร์", "วัฒนธรรม", "ประเพณี", "โบราณ", "ทันสมัย", "ล้ำยุค", "ลึกลับ", "ปริศนา", "เวทมนตร์", "ปาฏิหาริย์", "เหนือธรรมชาติ", "วิญญาณ", "ผี", "นรก", "สวรรค์", "โชคชะตา", "พรหมลิขิต", "กาลเวลา", "มิติที่สี่", "ความว่างเปล่า", "จุดเริ่มต้น", "จุดจบ", "นิรันดร์", "การเดินทาง", "ผจญภัย", "แผนที่", "เข็มทิศ", "เรือ", "เครื่องบิน", "รถยนต์", "รถไฟ", "จักรยาน", "เทคโนโลยี", "ความล้ำ", "สิ่งประดิษฐ์", "การค้นพบ", "ความจริง", "ความลี้ลับ", "แสง", "เสียง", "สัมผัส", "รสชาติ", "กลิ่น", "ชีวิต"]
};

// ============================================================
// [ระบบ 15 PILLARS MONITORING (ทำงานเบื้องหลัง)]
// ============================================================
const PILLARS_CORE = {
    P1_Tokenize: (t) => t.length > 0 ? "Analyzing Segments..." : null,
    P2_Vector: (t) => t.length > 1 ? "Mapping Vectors..." : null,
    P3_BigLang: (t) => t.includes('Lange') ? "Core Model Recognized!" : null,
    P4_MathLogic: (t) => /[\d\+\-\*\/\(\)]/.test(t) ? "Math Processor: ACTIVE" : null,
    P5_Sentiment: (t) => t.length > 5 ? "Context Scan: OK" : null,
    P6_ML_Layer: (t) => "Pattern Scanning...",
    P7_DL_Deep: (t) => "Hidden Neural Layer...",
    P8_Training: (t) => "Feedback Loop...",
    P9_Parameter: (t) => "Weight Optimization...",
    P10_Context: (t) => "Environment Scan...",
    P11_Logic: (t) => "Logic Verification...",
    P12_Sensory: (t) => "Sensory Mapping...",
    P13_Database: (t) => "Database Query...",
    P14_Technical: (t) => "Technical Synthesis...",
    P15_Synthesis: (t) => "Output Generation..."
};

// คลังประโยคตอบโต้ที่เป็นธรรมชาติ (Natural Responses)
const CHAT_STYLE = {
    "ทักทาย": ["สวัสดีครับ! วันนี้ Lange มีอะไรให้ช่วยไหม?", "โอ้ สวัสดีครับ! ดีใจที่ได้คุยกันนะ", "หวัดดีครับ! กำลังรอคำถามอยู่เลย"],
    "ธุรกิจ": ["เรื่องธุรกิจนี่น่าสนใจนะครับ", "ข้อมูลส่วนนี้ Lange จะช่วยวิเคราะห์ให้เองครับ", "มาวางแผนให้เติบโตไปด้วยกันเถอะ"],
    "สัตว์": ["สัตว์โลกน่ารักเสมอเลยนะครับ", "Lange ชอบหัวข้อเรื่องสัตว์มากเลยล่ะ", "สายพันธุ์นี้มีความพิเศษจริงๆ ครับ"],
    "คุยเล่น": ["ฮ่าๆ คุยกันสนุกดีนะครับ", "ผมชอบอารมณ์ขันของคุณจัง", "Lange พร้อมคุยเล่นเป็นเพื่อนเสมอครับ"],
    "ปรึกษา": ["เข้าใจเลยครับ Lange จะลองหาทางออกให้นะ", "เรื่องนี้เรามาช่วยกันคิดทีละสเต็ปนะครับ", "ปรึกษาได้ทุกเมื่อเลย Lange พร้อมรับฟังครับ"],
    "อิสระ": ["เป็นหัวข้อที่ล้ำลึกมากครับ", "โลกและจักรวาลนี้ยังมีเรื่องน่าทึ่งอีกเยอะเลย", "ขอบคุณที่แชร์ไอเดียดีๆ แบบนี้กับ Lange นะ"]
};

class LangeNaturalEngine {
    constructor() {
        this.acc = [380]; this.loss = [20];
        this.vocab = MASTER_DB;
    }

    solveMath(expr) {
        try {
            const clean = expr.replace(/[^-+/*()0-9.]/g, '');
            if(!clean) return null;
            return Function(`'use strict'; return (${clean})`)();
        } catch(e) { return null; }
    }

    process(text, isDev) {
        let activePillars = [];
        for(let key in PILLARS_CORE) {
            const status = PILLARS_CORE[key](text);
            if(status) activePillars.push(`${key}: ${status}`);
        }

        const math = this.solveMath(text);
        let foundCat = null;

        // ระบบเทรน (Admin Only)
        if(isDev && text.includes('-')) {
            const [cat, word] = text.split('-');
            if(this.vocab[cat]) this.vocab[cat].push(word);
            this.updateGraph(true);
            return { reply: `[SYSTEM] เทรนสำเร็จ: "${word}" เข้าสู่ระบบ ${cat}`, pillars: activePillars };
        }

        for(let cat in this.vocab) {
            if(this.vocab[cat].some(w => text.includes(w))) { foundCat = cat; break; }
        }

        this.updateGraph(foundCat !== null || math !== null);

        // ผลลัพธ์แบบ Natural Language
        if(math !== null) return { reply: `จากการคำนวณอย่างละเอียด ผลลัพธ์คือ ${math} ครับ`, isMath: true, pillars: activePillars };
        if(foundCat && CHAT_STYLE[foundCat]) {
            const randomReply = CHAT_STYLE[foundCat][Math.floor(Math.random() * CHAT_STYLE[foundCat].length)];
            return { reply: randomReply, pillars: activePillars };
        }
        
        return { reply: "อืม... Lange กำลังพยายามทำความเข้าใจสิ่งที่คุณสื่อสารอยู่ครับ ช่วยขยายความอีกนิดได้ไหม?", pillars: activePillars };
    }

    updateGraph(success) {
        let lastAcc = this.acc[this.acc.length-1];
        let lastLoss = this.loss[this.loss.length-1];
        let factor = success ? 0.08 : 0.35;
        this.acc.push(lastAcc + (50 - lastAcc) * factor + (Math.random()*12-6));
        this.loss.push(lastLoss + (350 - lastLoss) * factor + (Math.random()*12-6));
    }
}

const engine = new LangeNaturalEngine();
const HUB_ID = "LANGE_NET_V81";
let peer, conn, connections = [];

function unlockGate() {
    const name = document.getElementById('accessName').value.trim();
    if(!name) return;
    document.getElementById('gatekeeper').classList.add('hidden');
    if(name === "โตนัส") {
        const choice = confirm("สวัสดีคุณโตนัส! กด 'ตกลง' เข้า Lab (Admin) หรือ 'ยกเลิก' เข้า Monitor (Graph)");
        initRole(choice ? 'DEV' : 'MONITOR');
    } else {
        initRole('USER');
    }
}

function initRole(role) {
    if(role === 'DEV') {
        document.getElementById('devUI').classList.remove('hidden');
        renderFullVocab();
        peer = new Peer(HUB_ID);
        peer.on('open', id => new QRCode(document.getElementById("qrcode"), {text:id, width:64, height:64}));
        peer.on('connection', c => { connections.push(c); c.on('open', () => sync()); });
    } else if(role === 'MONITOR') {
        document.getElementById('monitorUI').classList.remove('hidden');
        peer = new Peer();
        document.body.innerHTML += '<div id="qr-modal" class="fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-50"><h3 class="text-white mb-6 font-black uppercase tracking-widest">Connect to Master-Lab</h3><div id="qr-reader" class="w-72 border-2 border-green-500 rounded-3xl overflow-hidden"></div></div>';
        const scn = new Html5Qrcode("qr-reader");
        scn.start({facingMode:"environment"}, {fps:10, qrbox:250}, id => {
            conn = peer.connect(id);
            scn.stop();
            document.getElementById('qr-modal').remove();
            conn.on('data', d => drawGraph(d.acc, d.loss));
        });
    } else {
        document.getElementById('userUI').classList.remove('hidden');
        peer = new Peer();
        setInterval(() => { if(!conn) { conn = peer.connect(HUB_ID); conn.on('data', d => { if(d.db) engine.vocab = d.db; }); } }, 2000);
    }
}

function renderFullVocab() {
    const list = document.getElementById('fullVocabList');
    list.innerHTML = Object.entries(engine.vocab).map(([cat, words]) => `
        <div class="mb-6">
            <h4 class="text-green-500 font-black underline mb-2 uppercase">${cat} (${words.length})</h4>
            <div class="flex flex-wrap gap-1">${words.map(w => `<span>${w}</span>`).join('|')}</div>
        </div>
    `).join('');
}

function sync() {
    const data = { db: engine.vocab, acc: engine.acc, loss: engine.loss };
    connections.forEach(c => c.send(data));
}

const handleChat = (formId, inputId, viewId, isDev) => {
    document.getElementById(formId).onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById(inputId);
        if(!input.value) return;
        const res = engine.process(input.value, isDev);
        const pLog = isDev ? `<div class="mt-4 pt-2 border-t border-[#30363d] text-[8px] opacity-40 uppercase tracking-widest">${res.pillars.join(' | ')}</div>` : '';
        document.getElementById(viewId).innerHTML += `
            <div class="msg-line user"><div class="bubble">${input.value}</div></div>
            <div class="msg-line assistant"><div class="bubble ${res.isMath ? 'math-box' : ''}">
                ${res.reply}${pLog}
            </div></div>`;
        input.value = "";
        document.getElementById(viewId).scrollTop = document.getElementById(viewId).scrollHeight;
        if(isDev) sync();
    };
}

handleChat('devForm', 'devInput', 'viewport', true);
handleChat('userForm', 'userInput', 'userViewport', false);

function drawGraph(acc, loss) {
    const path = (id, pts) => {
        let d = `M 0 ${pts[0]}`;
        const s = 1000 / (pts.length - 1);
        pts.forEach((p, i) => d += ` L ${i * s} ${p}`);
        document.getElementById(id).setAttribute('d', d);
    };
    path('pathAcc', acc); path('pathLoss', loss);
}
</script>
</body>
</html>
